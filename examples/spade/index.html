<!DOCTYPE html>
<html>
	<head>
		<title> Argure Demo: SPADE </title>
		<script src="../../spec/vendor/jquery-1.6.js"></script>
		<script src="../../spec/vendor/jquery.tmpl.js"></script>
		<script src="../../spec/vendor/knockout-1.2.1.debug.js"></script>
		<script src="../../spec/vendor/underscore.js"></script>
		<script src="../../public/javascripts/argure.js"></script>
	</head>
	<body>
		<div>	
			<!-- "view" for created panels -->
			<script id="panelsTemplate" type="text/html" charset="utf-8">
				<li>
					<form>
						<label for="panelFiles">Select Panel Files:</label>
						<select id="panelFiles" data-bind='collectionMultiSelect: panelFiles, optionsText: "name"' multiple=multiple></select>
						<label for="panelRefFiles">Select Reference Files:</label>
						<select id="panelRefFiles" data-bind='collectionMultiSelect: refFiles, optionsText: "name"' multiple=multiple></select>
						<label for="panelRefParams">Select Fold Change Parameters:</label>
						<select id="panelRefParams" data-bind='collectionMultiSelect: foldParams' multiple=multiple></select>
						<button data-bind="click: function() { $item.parentCollection.remove(this); }">Delete Panel</button>
					</form>
				</li>
			</script>

			<script id="spadeTemplate" type="text/html" charset="utf-8">	
				<h2>Setup Spade Analysis</h2>
				<form>
					<label for="slctdFiles">Select Files for Analysis:</label>
					<select id="slctdFiles" data-bind='collectionMultiSelect: files, optionsText: "name"' multiple="multiple"></select>
					<label for="clustParams">Select Clustering Parameters:</label>
					<select id="clustParams" data-bind='collectionMultiSelect: clusterParams' multiple=multiple ></select>
					<h3>Panels</h3>
					<ul data-bind='collectionTemplate: panels' ></ul>
					<button data-bind="click: create_panel">Create Another Panel</button>
				</form>
			</script>

			<h1>
				SPADE Command Synthesis
			</h1>
			<div data-bind='template: "spadeTemplate"'> 
			</div>


			<script type="text/coffeescript" charset="utf-8">
	
				class SpadePanel extends Argure.Model
					constructor: (@panelFiles_opts) ->
						super()

					common_params: (files) ->
						if files.length > 0 then files.slice(1).reduce ((m,p) -> _.intersect(m,p.pN)), files[0].pN else []

					@include Argure.Extensions.Set

					@collectionMultiSelect 'panelFiles'
					@collectionMultiSelect 'refFiles'
					@collectionMultiSelect 'foldParams'

					@relate (c) ->
						c.method 'refFiles_opts = panelFiles_slct'
					@relate (c) ->
						c.method 'foldParams_opts = common_params(panelFiles_slct)'


				# /SpadePanel

				class Spade extends Argure.Model
					constructor: (@files_opts) ->
						super()
						@create_panel()

					create_panel: -> @panels.push(new SpadePanel(@files_slct))
					common_params: (files) ->
						if files.length > 0 then files.slice(1).reduce ((m,p) -> _.intersect(m,p.pN)), files[0].pN else []

					@include Argure.Extensions.Set

					@collectionMultiSelect 'files'
					@collectionMultiSelect 'clusterParams'
					@relate (c) ->
						c.method 'clusterParams_opts = common_params(files_slct)'

					@collection 'panels', initial: []
													
				# /Spade

				this.spade = new Spade [
					{ name: "tube1.fcs", pN: ["cd3","cd4","cd8"] }
					{ name: "tube2.fcs", pN: ["cd3","cd4","cd19"] }
				]
				ko.applyBindings this.spade

			</script>
		</div>
			
	</body>
</html>

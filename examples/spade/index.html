<!DOCTYPE html>
<html>
	<head>
		<title> Argure Demo: SPADE </title>
		<script src="../../spec/vendor/jquery-1.6.js"></script>
		<script src="../../spec/vendor/jquery.tmpl.js"></script>
		<script src="../../spec/vendor/knockout-1.2.1.debug.js"></script>
		<script src="../../spec/vendor/underscore.js"></script>
		<script src="../../public/javascripts/argure.js"></script>
	</head>
	<body>
		<h1>
			SPADE Command Synthesis
		</h1>
		<div id="spadeArgure">
			
			<!-- "view" for created panels -->
			<script id="panelTemplate" type="text/html">
				<li>
					<p>
					File()s: {{each $data.files}} ${$value}, {{/each}}
					<br>
					Median Markers: All
					<br>
					Reference File(s): {{each $data.refFiles}} ${$value}, {{/each}} 
					<br>
					Fold Change Parameter(s): {{each $data.fldParams}} ${$value}, {{/each}} 
					</p>
					<button data-bind="click: function() { $item.model.panels.remove($data); }">Delete Panel</button>
				</li>
			</script>

			
			<h2>Setup Spade Analysis</h2>
			<form id="spadeMainArgs">
				
				<label for="slctdFiles">Select Files for Analysis:</label>
				<select id="slctdFiles" data-bind='options: files, selectedOptions: slctdFiles, optionsText: "name"' multiple="multiple"></select>
				
				<label for="clustParams">Select Clustering Parameters:</label>
				<select id="clustParams" data-bind='options: availClusterParams' multiple=multiple ></select>

				<h3>Current Panels</h3>
				<ul data-bind='template: { name: "panelTemplate", foreach: panels }' ></ul>
			</form>

			<h3> Create New or Additional Panels </h3>
			<form id="spadeCreatePanel" data-bind='submit: createPanel'>
				<label for="panelFiles">Select Panel Files:</label>
				<select id="panelFiles" data-bind='options: slctdFiles, selectedOptions: slctdPanelFiles, optionsText: "name"' multiple=multiple></select>

				<label for="panelRefFiles">Select Reference Files:</label>
				<select id="panelRefFiles" data-bind='options: slctdPanelFiles, selectedOptions: slctdRefFiles, optionsText: "name"' multiple=multiple></select>

				<label for="panelRefParams">Select Fold Change Parameters:</label>
				<select id="panelRefParams" data-bind='options: availFoldParams, selectedOptions: slctdFoldParams' multiple=multiple></select>

				<button type="submit">Create Panel</button>
			</form>
						

			<script type="text/coffeescript" charset="utf-8">
				
				class Spade extends Argure.Model
					constructor: (@files) ->
						super()

					common_params: (files) ->	
						if files.length > 0
							files.slice(1).reduce ((m,p) -> _.intersect(m,p.pN)), files[0].pN
						else
							[]

					createPanel: ->
						@panels @panels().concat
							files: file.name for file in @slctdPanelFiles().slice(0)
							refFiles: file.name for file in @slctdRefFiles().slice(0)
							fldParams: @slctdFoldParams().slice(0)
		
					@observe 'slctdFiles', initial: []
					@observe 'availClusterParams'
					@observe 'slctdClusterParams', initial: []
					@relate
						availClusterParams: -> @common_params @slctdFiles()
				
					@observe 'panels', initial: []

					@observe 'availPanelFiles'
					@observe 'slctdPanelFiles', initial: []
					@observe 'slctdRefFiles', initial: []
					@observe 'availFoldParams'
					@observe 'slctdFoldParams', initial: []

					@relate
						availPanelFiles: ->
							usedFiles = _.flatten p.files for p in @panels()
							_.reject @slctdFiles(), (f) -> _.include usedFiles, f.name

					@relate
						availFoldParams: -> @common_params @slctdPanelFiles()
					
				# /Spade

				this.spade = new Spade [
					{ name: "tube1.fcs", pN: ["cd3","cd4","cd8"] }
					{ name: "tube2.fcs", pN: ["cd3","cd4","cd19"] }
				]
				ko.applyBindings this.spade

				#spadeCMD = Argure.Model
				#	files:         Argure.ManyFromMany spadeFiles['files']
				#	clusterParams: Argure.ManyFromMany ->
				#		commonParams(@files.subset())
				#	panels:        Argure.Many()

				#	panelFiles: Argure.ManyFromMany ->
				#		usedFiles = _.flatten _.pluck @panels.set(), 'files'
				#		_.reject @files.subset(), (f) ->
				#			_.include usedFiles, f.name
				#	panelRefFiles: Argure.ManyFromMany ->
				#		@panelFiles.subset()
				#	panelFoldParams: Argure.ManyFromMany ->
				#		commonParams(@panelFiles.subset())

				#	createPanel: ->
				#		@panels.set.push
				#			files: file.name for file in @panelFiles.subset.splice(0)
				#			refFiles: file.name for file in @panelRefFiles.subset.splice(0)
				#			fldParams: @panelFoldParams.subset.splice(0)


				#ko.applyBindings(spadeCMD)


			</script>

			

		</div>
	</body>
</html>

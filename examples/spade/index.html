<!DOCTYPE html>
<html>
	<head>
		<title> Argure Demo: SPADE </title>
		<script src="../../spec/vendor/jquery-1.6.js"></script>
		<script src="../../spec/vendor/jquery.tmpl.js"></script>
		<script src="../../spec/vendor/knockout-1.2.1.debug.js"></script>
		<script src="../../spec/vendor/underscore.js"></script>
		<script src="../../public/javascripts/argure.js"></script>
	</head>
	<body>
		<h1>
			SPADE Command Synthesis
		</h1>
		<div id="spadeArgure">
			
			<!-- "view" for created panels -->
			<script id="panelTemplate" type="text/html">
				<li>
					<p>
					File()s: {{each $data.files}} ${$value}, {{/each}}
					<br>
					Median Markers: All
					<br>
					Reference File(s): {{each $data.refFiles}} ${$value}, {{/each}} 
					<br>
					Fold Change Parameter(s): {{each $data.fldParams}} ${$value}, {{/each}} 
					</p>
					<button data-bind="click: function() { $item.model.panels.set.remove($data); }">Delete Panel</button>
				</li>
			</script>

			
			<h2>Setup Spade Analysis</h2>
			<form id="spadeMainArgs">
				
				<label for="slctdFiles">Select Files for Analysis:</label>
				<select id="slctdFiles" data-bind='manyFromMany: files, optionsText: "name"' multiple="multiple"></select>
				
				<label for="clustParams">Select Clustering Parameters:</label>
				<select id="clustParams" data-bind='manyFromMany: clusterParams' multiple=multiple></select>

				<h3>Current Panels</h3>
				<ul data-bind='displayMany: panels, displayTemplate: "panelTemplate"'>
				</ul>
			</form>

			<h3> Create New or Additional Panels </h3>
			<form id="spadeCreatePanel" data-bind='submit: createPanel'>
				<label for="panelFiles">Select Panel Files:</label>
				<select id="panelFiles" data-bind='manyFromMany: panelFiles, optionsText: "name"' multiple=multiple></select>

				<label for="panelRefFiles">Select Reference Files:</label>
				<select id="panelRefFiles" data-bind='manyFromMany: panelRefFiles, optionsText: "name"' multiple=multiple></select>

				<label for="panelRefParams">Select Fold Change Parameters:</label>
				<select id="panelRefParams" data-bind='manyFromMany: panelFoldParams' multiple=multiple></select>

				<button type="submit">Create Panel</button>
			</form>
						
						
			<script type="text/javascript">
				// Example intializing data that might be returned from AJAX query					
				var spadeFiles = jQuery.parseJSON('{ \
					"files": [ \
						{ "name": "tube1.fcs", "pN": ["cd3","cd4","cd8"] }, \
						{ "name": "tube2.fcs", "pN": ["cd3","cd4","cd19"] } \
					] \
				}');

				// Return the array of parameters (pN) commons to all files in argument array
				function commonParams(files) {
					return (files.length > 0) ? _.reduce(files.slice(1), function(m,p) { return _.intersect(m,p.pN); }, _.first(files).pN) : [];
				}

			</script>

			<script type="text/coffeescript" charset="utf-8">
				
				
				spadeCMD = Argure.Model
					files:         Argure.ManyFromMany spadeFiles['files']
					clusterParams: Argure.ManyFromMany ->
						commonParams(@files.subset())
					panels:        Argure.Many()

					panelFiles: Argure.ManyFromMany ->
						usedFiles = _.flatten _.pluck @panels.set(), 'files'
						_.reject @files.subset(), (f) ->
							_.include usedFiles, f.name
					panelRefFiles: Argure.ManyFromMany ->
						@panelFiles.subset()
					panelFoldParams: Argure.ManyFromMany ->
						commonParams(@panelFiles.subset())

					createPanel: ->
						@panels.set.push
							files: file.name for file in @panelFiles.subset.splice(0)
							refFiles: file.name for file in @panelRefFiles.subset.splice(0)
							fldParams: @panelFoldParams.subset.splice(0)


				ko.applyBindings(spadeCMD)


			</script>

			

		</div>
	</body>
</html>
